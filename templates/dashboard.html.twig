{% extends 'base.html.twig' %}


{% block content %}
    <section class="sidebar-container">
      {# <StatusList ticketCreationList={ticketCreationList} /> #}
      {% include 'components/statuslist.html.twig' %}

      <div class="second-sidebar-container">
        <div class="sidebar">
          <div class="top">
            <div class="icon">
          <i class="fa-solid fa-table-columns"></i>
            </div>
            <h2>Dashboard</h2>
          </div>
{% include 'components/sidebar.html.twig' %}
        </div>

        <div class="creation">
        <div id="ticketCreationDiv">
{% include 'components/ticketcreation.html.twig' %} 
        </div>


        
       <div id="ticketListDiv">
       <div class="ticket-list-container"></div>
       </div>
        </div>
      </div>

    </section>



    <script> 
 

 const sidebardetails=[
  { 
     icon: '<i class="fa-solid fa-list-check"></i>',
     names: ' Ticket List',
   },
{ 
     icon:'<i class="fa-solid fa-square-plus"></i>' ,
     names: 'Create Ticket',
   },
{ 
     icon: '<i class="fa-solid fa-arrow-right-from-bracket"></i>',
     names: 'Log out',
   },
  ]



  








const inputValue= document.querySelectorAll("form div input");
const createBtn= document.querySelector("#createBtn")
const selectValue= document.querySelector("form div select")
const list= ["Open", "Close", "In progress"]
let ticketCreationList = JSON.parse(localStorage.getItem("ticketListStore")) || [];
let editIndex= null;
let ticketCreation ={
    title: "",
    description: "",
    status: "",
  };


  const handleTicketOnchange = (e) => {
    const { name, value } = e.target;
   ticketCreation[name]= value.trim() 
   console.log(ticketCreation)
  };




  const handleTicketCreation = () => {
 
    if (
      !ticketCreation.title ||
      !ticketCreation.description ||
      !ticketCreation.status
    ) {
      alert("please,check all fields");
      return;
    }

    let updatedList;

    if (editIndex !== null) {
      updatedList = ticketCreationList.map((ticket, index) =>
        index === editIndex ? { ...ticketCreation } : ticket
      );
      editIndex= null;
      alert("Ticket updated successfully");
    } else {
      updatedList = [...ticketCreationList, ticketCreation];
      alert("Ticket created successfully")

    }
    localStorage.setItem("ticketListStore", JSON.stringify(updatedList));
    ticketCreationList= updatedList;
    ticketCreation= {
      title: "",
      description: "",
      status: "",
    };

    
    inputValue.forEach(input => input.value = "");
selectValue.value = "";
 
  isOpen = " Ticket List"; 
  renderTab();
  };






console.log(ticketCreationList)



document.addEventListener("DOMContentLoaded", () => {
  const createBtn = document.querySelector("#createBtn");
  createBtn.addEventListener("click", handleTicketCreation);
});

inputValue.forEach(input => {
  input.addEventListener("change", handleTicketOnchange)
});    

selectValue.addEventListener("change", handleTicketOnchange)



const handleDelete = (value) => {
    const updatedList = ticketCreationList.filter(
      (ticket) => ticket.title !== value
    );
    alert("Ticket Deleted successfully");
    ticketCreationList= updatedList;
    localStorage.setItem("ticketListStore", JSON.stringify(updatedList));
      renderTicketList()
  };

  const handleEdit = (index) => {
    const ticketToEdit = ticketCreationList[index];
    alert("Ticket Edited successfully");
    ticketCreation= { ...ticketToEdit };
    editIndex= index;
  };

    renderTicketList()

 
  const safeList = Array.isArray(ticketCreationList) ? ticketCreationList : [];



  const statusLists = [
    { label: "Total Tickets", value: safeList.length },
    {
      label: "Open Tickets",
      value: safeList.filter((item) => item.status === "open").length,
    },

    {
      label: "Resolve Tickets",
      value: safeList.filter((item) => item.status === "closed").length,
    },
  ];

// 




// Sidebar container
const sidebarContainer = document.querySelector(".sidebar-components");


const ticketCreationDiv = document.querySelector("#ticketCreationDiv");
const ticketListDiv = document.querySelector("#ticketListDiv");
let isOpen = "Create Ticket";



function renderTab() {
  if (isOpen === "Create Ticket") {
    ticketCreationDiv.style.display = "block";
    ticketListDiv.style.display = "none";
  } else if(isOpen === " Ticket List"){ 
    ticketCreationDiv.style.display = "none";
    ticketListDiv.style.display = "block";
    renderTicketList(); 
  }
}
renderTab();




// Logout function
const handleLogout = () => {
  localStorage.removeItem("Loginstore");
  window.location.href = "index.php?page=signup";
};


sidebardetails.forEach((item) => {
  const div = document.createElement("div");
  div.classList.add("sidebar-item");
  div.setAttribute("data-tab", item.names);

  div.innerHTML = `
    <div class="sidebar-flex" style="${item.names === 'Log out' ? 'margin-top:20px; color:white; background-color:red; border:none;' : ''}">
      <div class="icon">${item.icon}</div>
      <h3>${item.names}</h3>
    </div>
  `;

  div.addEventListener("click", () => {
    if (item.names === 'Log out') {
      handleLogout();
    } else {
      isOpen = item.names;
      renderTab();
    }
  });

  sidebarContainer.appendChild(div);
});






function renderTicketList() {
  const ticketListContainer = document.querySelector(".ticket-list-container");
  
   if (!ticketListContainer) {
    console.error("ticket-list-container not found");
    return;
  }

  ticketListContainer.innerHTML = ""; 
if (ticketCreationList.length === 0) {
    ticketListContainer.innerHTML = "<p>No tickets available</p>";
    return;
  }
  


  ticketCreationList.forEach((ticket, index) => {
    const ticketDiv = document.createElement("div");
    ticketDiv.classList.add("ticket-list");
    ticketDiv.innerHTML = `
      <h2>${ticket.title}</h2>
      <p>${ticket.description}</p>
      <p>
        Status: <span class="status-badge status-${ticket.status}">
          ${ticket.status.replace('_', ' ')}
        </span>
      </p>
      <div class="actn-btn">
        <button class="edit" data-index="${index}">Edit</button>
        <button class="delete" data-title="${ticket.title}">Delete</button>
      </div>
    `;
    ticketListContainer.appendChild(ticketDiv);
  });
  

  attachEventListeners();
}

function attachEventListeners() {
  document.querySelectorAll(".edit").forEach(btn => {
    btn.addEventListener("click", () => {
      const index = parseInt(btn.dataset.index);
      handleEdit(index);
    });
  });

  document.querySelectorAll(".delete").forEach(btn => {
    btn.addEventListener("click", () => {
      const title = btn.dataset.title;
      handleDelete(title);
    });
  });
}

    
    </script>

{% endblock %}
